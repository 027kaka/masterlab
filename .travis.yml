language: php

dist: trusty
sudo: required

php:
  - 7.2

env:
  - APP_STATUS=development

services:
  - redis-server
  - mysql
  - nginx

matrix:
  fast_finish: true

branches:
  only:
  - master
  - travis

cache:
  apt: true

before_install:
  - sudo mysql -e "use mysql; update user set authentication_string=PASSWORD('Masterlab123') where User='root'; update user set plugin='mysql_native_password';FLUSH PRIVILEGES;"
  - sudo mysql_upgrade -u root -pMasterlab123
  - sudo service mysql restart
  - sudo mysql -e "create database IF NOT EXISTS masterlab_ci;" -uroot -pMasterlab123
  - sudo mysql -e "SET sql_mode = 'IGNORE_SPACE,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';use masterlab_ci;source $TRAVIS_BUILD_DIR/masterlab.sql;" -uroot -pMasterlab123

before_script:
  #- git clone https://github.com/gopeak/hornet-framework.git
  #- git clone https://github.com/phpredis/phpredis.git
  #- cd phpredis/
  #- phpize
  #- ./configure
  #- make
  #- make install

script:
  - ls $TRAVIS_BUILD_DIR
  - cd $TRAVIS_BUILD_DIR
  - git checkout  travis
  - git pull origin travis
  - sudo chmod +x /home/travis/build/gopeak/masterlab/travis/install-nginx.sh
  - sudo /home/travis/build/gopeak/masterlab/travis/install-nginx.sh
  - curl -vsf 'http://localhost:8080/hello.php' &> /dev/stdout
  - cat /tmp/error.log
  - composer update
  - php test_mysql.php
  - cd app/test

notifications:
  email:
    - 121642038@qq.com

addons:
  ssh_known_hosts: 47.244.62.11
  hosts:
    - travis.test
    - masterlab.ci
  apt:
      sources:
        - mysql-5.7-trusty
      packages:
        - mysql-server
        - mysql-client

