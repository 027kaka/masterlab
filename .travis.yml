language: php
dist: trusty
sudo: required
php:
  - 7.2

env:
  - APP_STATUS=development

services:
  - redis
  - mysql5.7
  - nginx

branches:
  only:
  - master
  - travis

before_install:
  - sudo mysql -e "use mysql; update user set authentication_string=PASSWORD('Masterlab123') where User='root'; update user set plugin='mysql_native_password';FLUSH PRIVILEGES;"
  - sudo mysql_upgrade -u root -pMasterlab123
  - sudo service mysql restart
  - mysql -e -u root -pMasterlab123 "create database IF NOT EXISTS masterlab_ci  character set utf8mb4 collate utf8mb4_unicode_ci"
  - mysql -e -u root -pMasterlab123  "use masterlab_ci;source $TRAVIS_BUILD_DIR/masterlab.sql"

before_script:
  - git clone https://github.com/gopeak/hornet-framework.git
  - git clone https://github.com/phpredis/phpredis.git
  - cd phpredis/
  - phpize
  - ./configure
  - make
  - make install

script:

  - cd $TRAVIS_BUILD_DIR/gopeak/masterlab
  - composer update
  - php test_mysql.php
  - cd app/test

notifications:
  email:
    - 121642038@qq.com

addons:
  ssh_known_hosts: 47.244.62.11
  hosts:
    - travis.test
    - masterlab.ci
  apt:
    sources:
      - mysql-5.7-trusty
    packages:
      - mysql-server
      - mysql-client

cache:
  directories:
  - vendor